name: Test SSH Connection

"on":
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Server hostname or IP'
        required: true
        default: 'acws.duckdns.org'

env:
  SERVER_USER: ubuntu

jobs:
  test-connection:
    runs-on: ubuntu-latest

    steps:
      - name: Check SSH secret exists
        run: |
          echo "Checking if SSH secret is available..."
          if [ -z "${{ secrets.NGINX_SERVER_SSH_KEY }}" ]; then
            echo "❌ ERROR: NGINX_SERVER_SSH_KEY secret is not set or is empty"
            echo "Please check GitHub repository secrets"
            exit 1
          else
            echo "✅ SSH secret is available"
            echo "Secret length: $(echo '${{ secrets.NGINX_SERVER_SSH_KEY }}' | wc -c) characters"
          fi

      - name: Test network connectivity
        run: |
          echo "Testing network connectivity to ${{ github.event.inputs.server_host }}"

          # Test DNS resolution
          echo "Testing DNS resolution..."
          nslookup ${{ github.event.inputs.server_host }} || echo "DNS resolution failed"

          # Test ping
          echo "Testing ping..."
          ping -c 3 ${{ github.event.inputs.server_host }} || echo "Ping failed"

          # Test port 22
          echo "Testing SSH port 22..."
          nc -zv ${{ github.event.inputs.server_host }} 22 || echo "Port 22 not accessible"

      - name: Test SSH key format
        run: |
          echo "Testing SSH key format..."

          # Setup SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.NGINX_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Check key format
          echo "Checking SSH key format..."
          ssh-keygen -l -f ~/.ssh/id_rsa || echo "Invalid SSH key format"

          # Check key type
          echo "SSH key details:"
          file ~/.ssh/id_rsa
          head -1 ~/.ssh/id_rsa

      - name: Test SSH connection with detailed output
        run: |
          echo "Testing SSH connection with maximum verbosity..."

          # Add server to known hosts
          ssh-keyscan -H ${{ github.event.inputs.server_host }} >> ~/.ssh/known_hosts

          # Test SSH with maximum verbosity
          echo "Attempting SSH connection..."
          ssh -vvv -o ConnectTimeout=30 -o StrictHostKeyChecking=no ${{ env.SERVER_USER }}@${{ github.event.inputs.server_host }} "echo 'Connection successful'" || echo "SSH connection failed"
