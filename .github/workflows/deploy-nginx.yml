# Deploy Campus Workshop to Nginx Server (mb-acws1)
name: Deploy to Nginx Server

on:
  # Automatic deployment when GitHub Pages deployment completes
  workflow_run:
    workflows: ["Deploy Campus Workshop Documentation"]
    types:
      - completed
    branches: [main]

  # Manual trigger for nginx deployment (with options)
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Server hostname or IP'
        required: true
        default: 'acws.duckdns.org'
      force_update:
        description: 'Force update even if no changes'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (test without deploying)'
        type: boolean
        default: false

env:
  SERVER_USER: ubuntu
  SERVER_PATH: /var/www/mkdocs/site
  NGINX_SERVICE: nginx

jobs:
  deploy-to-nginx:
    runs-on: ubuntu-latest
    # Run for both automatic (workflow_run) and manual (workflow_dispatch) triggers
    # Skip if the triggering workflow failed (for workflow_run events)
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.NGINX_SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

      - name: Check server connectivity
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üîó Testing connection to $SERVER_HOST..."
          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "echo 'Connection successful to Campus Workshop server'"

      - name: Backup current Mike site (SAFE)
        if: ${{ github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üíæ Creating backup of operational Mike site..."
          echo "üéØ Target: ${{ env.SERVER_PATH }} (existing operational site)"

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            if [ -d '${{ env.SERVER_PATH }}' ]; then
              echo '‚úÖ Operational Mike site found: ${{ env.SERVER_PATH }}'

              # Create timestamped backup
              BACKUP_DIR='${{ env.SERVER_PATH }}.backup.$(date +%Y%m%d_%H%M%S)'
              echo \"üì¶ Creating backup: \$BACKUP_DIR\"
              sudo cp -r '${{ env.SERVER_PATH }}' \"\$BACKUP_DIR\"

              # Verify backup
              if [ -d \"\$BACKUP_DIR\" ]; then
                echo '‚úÖ Backup created successfully'
                echo \"üìä Backup size: \$(sudo du -sh \$BACKUP_DIR | cut -f1)\"
              else
                echo '‚ùå Backup creation failed!'
                exit 1
              fi
            else
              echo '‚ùå CRITICAL: Operational site not found at ${{ env.SERVER_PATH }}'
              echo 'Expected existing Mike setup - aborting to prevent data loss'
              exit 1
            fi
          "

      - name: SAFE Mike version update (preserves operational site)
        if: ${{ github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üîÑ SAFE UPDATE: Updating Mike versions without overwriting operational site"
          echo "üéØ Target: ${{ env.SERVER_PATH }} (operational Mike site)"
          echo "üõ°Ô∏è Orlando 2025.1.ORL will be preserved"

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            # Verify operational Mike site exists
            if [ ! -d '${{ env.SERVER_PATH }}' ]; then
              echo '‚ùå CRITICAL: Operational site not found at ${{ env.SERVER_PATH }}'
              echo 'Aborting to prevent data loss'
              exit 1
            fi

            # Verify Mike structure
            if [ ! -f '${{ env.SERVER_PATH }}/versions.json' ]; then
              echo '‚ùå CRITICAL: No Mike versions.json found'
              echo 'This does not appear to be a Mike-managed site'
              echo 'Aborting to prevent overwriting operational site'
              exit 1
            fi

            echo '‚úÖ Operational Mike site verified'
            echo 'üìã Current site structure:'
            ls -la '${{ env.SERVER_PATH }}/' | head -10

            # Extra protection: Backup Orlando if it exists
            if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
              echo 'üõ°Ô∏è Extra Orlando protection: Creating backup...'
              sudo cp -r '${{ env.SERVER_PATH }}/2025.1.ORL' '/tmp/orlando-protection-$(date +%s)'
              echo '‚úÖ Orlando protection backup created'
            fi

            # Clone fresh content to temporary staging area
            TEMP_DIR=\"/tmp/mike-update-staging-\$(date +%s)\"
            echo \"üì• Cloning fresh content to staging area: \$TEMP_DIR\"
            git clone -b gh-pages git@github.com:${{ github.repository }}.git \"\$TEMP_DIR\"

            if [ ! -d \"\$TEMP_DIR\" ]; then
              echo '‚ùå Failed to clone fresh content'
              exit 1
            fi

            echo '‚úÖ Fresh content staged successfully'

            # SAFE UPDATE: Only update specific version directories (not root files)
            echo 'üîÑ SAFE UPDATE: Updating individual version directories only...'

            for version_dir in \"\$TEMP_DIR\"/*/; do
              if [ -d \"\$version_dir\" ]; then
                version_name=\$(basename \"\$version_dir\")

                # Skip Orlando (protected)
                if [ \"\$version_name\" = \"2025.1.ORL\" ]; then
                  echo \"üõ°Ô∏è PROTECTED: Skipping Orlando version: \$version_name\"
                  continue
                fi

                # Skip non-version directories
                if [[ ! \"\$version_name\" =~ ^20[0-9]{2}\.[0-9]+\.[A-Z]{3}$ ]]; then
                  echo \"‚è≠Ô∏è  Skipping non-version directory: \$version_name\"
                  continue
                fi

                echo \"üìÅ Updating version: \$version_name\"

                # Create version directory if it doesn't exist
                sudo mkdir -p '${{ env.SERVER_PATH }}/'\$version_name

                # SAFE: Sync only the version content (not destructive)
                sudo rsync -av --delete \"\$version_dir/\" '${{ env.SERVER_PATH }}/'\$version_name'/'

                if [ \$? -eq 0 ]; then
                  echo \"‚úÖ Version \$version_name updated successfully\"
                else
                  echo \"‚ùå Failed to update version \$version_name\"
                fi
              fi
            done

            # SAFE: Update only Mike metadata files (preserve existing structure)
            echo 'üìÑ SAFE UPDATE: Updating Mike metadata files...'

            # Update versions.json if it exists in the new content
            if [ -f \"\$TEMP_DIR/versions.json\" ]; then
              echo 'üìä Updating versions.json...'
              sudo cp \"\$TEMP_DIR/versions.json\" '${{ env.SERVER_PATH }}/versions.json'
              echo '‚úÖ versions.json updated'
            fi

            # Update main index.html if it exists (but preserve existing if not)
            if [ -f \"\$TEMP_DIR/index.html\" ]; then
              echo 'üè† Updating main index.html...'
              sudo cp \"\$TEMP_DIR/index.html\" '${{ env.SERVER_PATH }}/index.html'
              echo '‚úÖ Main index.html updated'
            fi

            # Verify Orlando is still intact (critical check)
            if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
              echo '‚úÖ VERIFICATION: Orlando 2025.1.ORL still intact'
              echo \"üìä Orlando size: \$(sudo du -sh '${{ env.SERVER_PATH }}/2025.1.ORL' | cut -f1)\"
            else
              echo '‚ùå CRITICAL: Orlando 2025.1.ORL was lost during update!'
              echo 'üîÑ Restoring from protection backup...'
              if ls /tmp/orlando-protection-* 1> /dev/null 2>&1; then
                sudo cp -r /tmp/orlando-protection-* '${{ env.SERVER_PATH }}/2025.1.ORL'
                echo '‚úÖ Orlando restored from protection backup'
              else
                echo '‚ùå No Orlando protection backup found!'
                echo 'üö® MANUAL INTERVENTION REQUIRED'
                exit 1
              fi
            fi

            # Clean up staging area
            rm -rf \$TEMP_DIR
            echo 'üßπ Staging area cleaned up'

            echo '‚úÖ SAFE UPDATE COMPLETED: Mike versions updated without overwriting operational site'
            echo 'üõ°Ô∏è Orlando 2025.1.ORL protection verified'
          "

      - name: Dry run - SAFE update simulation
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üß™ DRY RUN: SAFE Mike version update simulation"
          echo "üéØ Target: ${{ env.SERVER_PATH }} (operational Mike site)"

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            echo 'üß™ DRY RUN: Checking operational site status...'

            if [ -d '${{ env.SERVER_PATH }}' ]; then
              echo '‚úÖ Operational Mike site found: ${{ env.SERVER_PATH }}'

              if [ -f '${{ env.SERVER_PATH }}/versions.json' ]; then
                echo '‚úÖ Mike versioning detected (versions.json found)'
                echo 'üìã Current versions on server:'
                ls -la '${{ env.SERVER_PATH }}/' | grep '^d' | grep -E '20[0-9]{2}\.[0-9]+\.[A-Z]{3}' || echo 'No version directories found'

                if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
                  echo 'üõ°Ô∏è Orlando 2025.1.ORL detected - WOULD BE PROTECTED'
                  echo \"üìä Orlando size: \$(sudo du -sh '${{ env.SERVER_PATH }}/2025.1.ORL' | cut -f1)\"
                fi

                echo ''
                echo 'üß™ DRY RUN: What would happen:'
                echo '  1. ‚úÖ Create backup of entire operational site'
                echo '  2. ‚úÖ Create extra Orlando protection backup'
                echo '  3. ‚úÖ Clone fresh content to staging area'
                echo '  4. ‚úÖ Update individual version directories (except Orlando)'
                echo '  5. ‚úÖ Update Mike metadata files (versions.json, index.html)'
                echo '  6. ‚úÖ Verify Orlando protection intact'
                echo '  7. ‚úÖ Clean up staging area'
                echo ''
                echo 'üõ°Ô∏è PROTECTION: Orlando 2025.1.ORL would remain untouched'
                echo 'üîí SAFETY: No destructive operations on operational site'
              else
                echo '‚ùå No Mike versioning found - would abort to prevent data loss'
              fi
            else
              echo '‚ùå Operational site not found - would abort to prevent data loss'
            fi

            echo ''
            echo 'üß™ DRY RUN COMPLETE: No actual changes made'
          "

      - name: Set proper permissions
        if: ${{ github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üîê Setting proper permissions..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            sudo chown -R www-data:www-data '${{ env.SERVER_PATH }}'
            sudo chmod -R 755 '${{ env.SERVER_PATH }}'
            sudo find '${{ env.SERVER_PATH }}' -type f -exec chmod 644 {} \;
            echo '‚úÖ Permissions set'
          "

      - name: Validate nginx configuration
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üîß Validating nginx configuration..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            sudo nginx -t
            if [ \$? -eq 0 ]; then
              echo '‚úÖ Nginx configuration is valid'
            else
              echo '‚ùå Nginx configuration has errors'
              exit 1
            fi
          "

      - name: Reload nginx
        if: ${{ github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üîÑ Reloading nginx..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            sudo systemctl reload ${{ env.NGINX_SERVICE }}
            sudo systemctl status ${{ env.NGINX_SERVICE }} --no-pager -l
            echo '‚úÖ Nginx reloaded'
          "

      - name: Test site accessibility and Orlando protection
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üåê Testing Campus Workshop site accessibility..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            # Test local nginx response
            HTTP_CODE=\$(curl -s -o /dev/null -w '%{http_code}' http://localhost/)
            if [ \"\$HTTP_CODE\" = '200' ]; then
              echo \"‚úÖ Local site is accessible (HTTP \$HTTP_CODE)\"
            else
              echo \"‚ö†Ô∏è Local site returned HTTP \$HTTP_CODE\"
            fi

            # Test if site directory and index.html exist
            if [ -d '${{ env.SERVER_PATH }}' ]; then
              echo '‚úÖ Site directory exists'
              if [ -f '${{ env.SERVER_PATH }}/index.html' ]; then
                echo '‚úÖ index.html found'
              else
                echo '‚ùå index.html not found'
              fi
              
              # Verify Orlando protection
              if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
                echo 'üõ°Ô∏è ‚úÖ Orlando 2025.1.ORL version is present and protected'
                if [ -f '${{ env.SERVER_PATH }}/2025.1.ORL/index.html' ]; then
                  echo 'üõ°Ô∏è ‚úÖ Orlando index.html is intact'
                else
                  echo 'üõ°Ô∏è ‚ùå Orlando index.html missing!'
                fi
              else
                echo 'üõ°Ô∏è ‚ö†Ô∏è Orlando 2025.1.ORL version not found'
              fi
            else
              echo '‚ùå Site directory does not exist: ${{ env.SERVER_PATH }}'
            fi
          "

      - name: Create deployment summary
        run: |
          IS_DRY_RUN="${{ github.event.inputs.dry_run }}"

          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "## üß™ Campus Workshop Nginx Dry Run Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Mode**: DRY RUN (No actual deployment)" >> $GITHUB_STEP_SUMMARY
            echo "- **Server**: ${{ github.event.inputs.server_host || 'mb-acws1' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Path**: ${{ env.SERVER_PATH }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Orlando Protection**: üõ°Ô∏è 2025.1.ORL would be protected" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: ‚úÖ Dry Run Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## üöÄ Campus Workshop Nginx Deployment Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Server**: ${{ github.event.inputs.server_host || 'mb-acws1' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Path**: ${{ env.SERVER_PATH }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Orlando Protection**: üõ°Ô∏è 2025.1.ORL protected during update" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: ‚úÖ Deployed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üåê Site URLs" >> $GITHUB_STEP_SUMMARY
            echo "- **Main Site**: http://mb-acws1/" >> $GITHUB_STEP_SUMMARY
            echo "- **Orlando (Protected)**: http://mb-acws1/2025.1.ORL/" >> $GITHUB_STEP_SUMMARY
            echo "- **GitHub Pages**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          fi

  notify-deployment:
    needs: deploy-to-nginx
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify deployment result
        run: |
          if [[ "${{ needs.deploy-to-nginx.result }}" == "success" ]]; then
            echo "‚úÖ Campus Workshop nginx deployment completed successfully!"
            echo "üåê Site is now live at: http://mb-acws1/"
            echo "üõ°Ô∏è Orlando 2025.1.ORL remains protected"
          else
            echo "‚ùå Campus Workshop nginx deployment failed!"
            echo "Please check the deployment logs for details."
          fi
