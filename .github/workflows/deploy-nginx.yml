# Deploy Campus Workshop to Nginx Server (mb-acws1)
name: Deploy to Nginx Server

on:
  # Automatic deployment when GitHub Pages deployment completes
  workflow_run:
    workflows: ["Deploy Campus Workshop Documentation"]
    types:
      - completed
    branches: [main]

  # Manual trigger for nginx deployment (with options)
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Server hostname or IP'
        required: true
        default: 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com'
      force_update:
        description: 'Force update even if no changes'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (test without deploying)'
        type: boolean
        default: false

env:
  SERVER_USER: ubuntu
  SERVER_PATH: /var/www/campus-workshop
  NGINX_SERVICE: nginx

jobs:
  deploy-to-nginx:
    runs-on: ubuntu-latest
    # Run for both automatic (workflow_run) and manual (workflow_dispatch) triggers
    # Skip if the triggering workflow failed (for workflow_run events)
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success') }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.NGINX_SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com' }}"
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

      - name: Check server connectivity
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com' }}"
          echo "üîó Testing connection to $SERVER_HOST..."
          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "echo 'Connection successful to Campus Workshop server'"

      - name: Backup current site
        if: ${{ github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com' }}"
          echo "üíæ Creating backup of current Campus Workshop site..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            if [ -d '${{ env.SERVER_PATH }}' ]; then
              sudo cp -r '${{ env.SERVER_PATH }}' '${{ env.SERVER_PATH }}.backup.$(date +%Y%m%d_%H%M%S)'
              echo '‚úÖ Backup created'
            else
              echo '‚ö†Ô∏è No existing site to backup'
            fi
          "

      - name: Update site from GitHub with Mike version protection
        if: ${{ github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com' }}"
          echo "üîÑ Updating Campus Workshop site from GitHub with Orlando protection..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            # Check if site directory exists and has Mike versioning
            if [ -d '${{ env.SERVER_PATH }}' ]; then
              echo 'üìÅ Site directory exists, checking for Mike versioning...'

              # Check if Mike versioning structure exists (2025.1.ORL directory)
              if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
                echo 'üõ°Ô∏è Mike versioning detected with Orlando protection - selective update...'

                # Clone fresh content to temporary directory using SSH
                TEMP_DIR=\"/tmp/campus-workshop-update-\$(date +%s)\"
                git clone -b gh-pages git@github.com:${{ github.repository }}.git \"\$TEMP_DIR\"

                if [ -d \"\$TEMP_DIR\" ]; then
                  echo 'üì• Fresh content cloned to temporary directory'

                  # Backup Orlando version before any updates
                  if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
                    echo 'üõ°Ô∏è Backing up Orlando 2025.1.ORL version...'
                    sudo cp -r '${{ env.SERVER_PATH }}/2025.1.ORL' '/tmp/orlando-backup-$(date +%s)'
                  fi

                  # Update all versions EXCEPT Orlando 2025.1.ORL
                  echo 'üîÑ Updating all versions except protected Orlando...'
                  
                  # Update root files (index.html, versions.json, etc.)
                  sudo rsync -av --exclude='2025.1.ORL' \"\$TEMP_DIR/\" '${{ env.SERVER_PATH }}/'
                  
                  # Update individual versions (but skip Orlando)
                  for version_dir in \"\$TEMP_DIR\"/*/; do
                    version_name=\$(basename \"\$version_dir\")
                    if [ \"\$version_name\" != \"2025.1.ORL\" ]; then
                      echo \"üîÑ Updating version: \$version_name\"
                      sudo rsync -av --delete \"\$version_dir\" '${{ env.SERVER_PATH }}/\$version_name/'
                    else
                      echo \"üõ°Ô∏è Skipping protected Orlando version: \$version_name\"
                    fi
                  done

                  # Verify Orlando is still intact
                  if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
                    echo '‚úÖ Orlando 2025.1.ORL protection verified - version intact'
                  else
                    echo '‚ùå CRITICAL: Orlando 2025.1.ORL was lost! Restoring from backup...'
                    sudo cp -r '/tmp/orlando-backup-'* '${{ env.SERVER_PATH }}/2025.1.ORL' || echo 'Backup restore failed!'
                  fi

                  # Clean up temporary directory
                  rm -rf \$TEMP_DIR
                else
                  echo '‚ùå Failed to clone fresh content'
                  exit 1
                fi
              else
                echo 'üÜï No Mike versioning - performing full update...'
                cd '${{ env.SERVER_PATH }}'

                # Standard git update for non-Mike sites
                if [ -d '.git' ]; then
                  sudo git fetch origin && sudo git reset --hard origin/gh-pages
                else
                  cd /var/www/
                  sudo mv '${{ env.SERVER_PATH }}' '${{ env.SERVER_PATH }}.old'
                  sudo git clone -b gh-pages git@github.com:${{ github.repository }}.git '${{ env.SERVER_PATH }}'
                fi
              fi
            else
              echo 'üÜï Site directory does not exist, creating and cloning repository...'
              cd /var/www/
              sudo mkdir -p \$(dirname '${{ env.SERVER_PATH }}')
              sudo git clone -b gh-pages git@github.com:${{ github.repository }}.git '${{ env.SERVER_PATH }}'
            fi

            echo '‚úÖ Campus Workshop site updated from GitHub with Orlando protection'
          "

      - name: Dry run - Update simulation
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com' }}"
          echo "üß™ DRY RUN: Would update Campus Workshop site from GitHub..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            if [ -d '${{ env.SERVER_PATH }}' ]; then
              echo 'üìÅ Site directory exists'
              
              if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
                echo 'üõ°Ô∏è Orlando 2025.1.ORL detected - would be protected during update'
                echo 'üß™ Would selectively update all versions except Orlando'
              fi
              
              cd '${{ env.SERVER_PATH }}'

              if [ -d '.git' ]; then
                echo 'üß™ Would run: git fetch origin && git reset --hard origin/gh-pages'
                echo 'Current branch:' \$(git branch --show-current)
                echo 'Current commit:' \$(git log -1 --oneline)
              else
                echo 'üß™ Directory exists but not a git repo - would re-clone'
              fi
            else
              echo 'üß™ Site directory does not exist - would create and clone'
            fi
          "

      - name: Set proper permissions
        if: ${{ github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com' }}"
          echo "üîê Setting proper permissions..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            sudo chown -R www-data:www-data '${{ env.SERVER_PATH }}'
            sudo chmod -R 755 '${{ env.SERVER_PATH }}'
            sudo find '${{ env.SERVER_PATH }}' -type f -exec chmod 644 {} \;
            echo '‚úÖ Permissions set'
          "

      - name: Validate nginx configuration
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com' }}"
          echo "üîß Validating nginx configuration..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            sudo nginx -t
            if [ \$? -eq 0 ]; then
              echo '‚úÖ Nginx configuration is valid'
            else
              echo '‚ùå Nginx configuration has errors'
              exit 1
            fi
          "

      - name: Reload nginx
        if: ${{ github.event_name == 'workflow_run' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com' }}"
          echo "üîÑ Reloading nginx..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            sudo systemctl reload ${{ env.NGINX_SERVICE }}
            sudo systemctl status ${{ env.NGINX_SERVICE }} --no-pager -l
            echo '‚úÖ Nginx reloaded'
          "

      - name: Test site accessibility and Orlando protection
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'ec2-3-148-13-216.us-east-2.compute.amazonaws.com' }}"
          echo "üåê Testing Campus Workshop site accessibility..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            # Test local nginx response
            HTTP_CODE=\$(curl -s -o /dev/null -w '%{http_code}' http://localhost/)
            if [ \"\$HTTP_CODE\" = '200' ]; then
              echo \"‚úÖ Local site is accessible (HTTP \$HTTP_CODE)\"
            else
              echo \"‚ö†Ô∏è Local site returned HTTP \$HTTP_CODE\"
            fi

            # Test if site directory and index.html exist
            if [ -d '${{ env.SERVER_PATH }}' ]; then
              echo '‚úÖ Site directory exists'
              if [ -f '${{ env.SERVER_PATH }}/index.html' ]; then
                echo '‚úÖ index.html found'
              else
                echo '‚ùå index.html not found'
              fi
              
              # Verify Orlando protection
              if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
                echo 'üõ°Ô∏è ‚úÖ Orlando 2025.1.ORL version is present and protected'
                if [ -f '${{ env.SERVER_PATH }}/2025.1.ORL/index.html' ]; then
                  echo 'üõ°Ô∏è ‚úÖ Orlando index.html is intact'
                else
                  echo 'üõ°Ô∏è ‚ùå Orlando index.html missing!'
                fi
              else
                echo 'üõ°Ô∏è ‚ö†Ô∏è Orlando 2025.1.ORL version not found'
              fi
            else
              echo '‚ùå Site directory does not exist: ${{ env.SERVER_PATH }}'
            fi
          "

      - name: Create deployment summary
        run: |
          IS_DRY_RUN="${{ github.event.inputs.dry_run }}"

          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "## üß™ Campus Workshop Nginx Dry Run Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Mode**: DRY RUN (No actual deployment)" >> $GITHUB_STEP_SUMMARY
            echo "- **Server**: ${{ github.event.inputs.server_host || 'mb-acws1' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Path**: ${{ env.SERVER_PATH }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Orlando Protection**: üõ°Ô∏è 2025.1.ORL would be protected" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: ‚úÖ Dry Run Completed" >> $GITHUB_STEP_SUMMARY
          else
            echo "## üöÄ Campus Workshop Nginx Deployment Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Server**: ${{ github.event.inputs.server_host || 'mb-acws1' }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Path**: ${{ env.SERVER_PATH }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Orlando Protection**: üõ°Ô∏è 2025.1.ORL protected during update" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: ‚úÖ Deployed Successfully" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### üåê Site URLs" >> $GITHUB_STEP_SUMMARY
            echo "- **Main Site**: http://mb-acws1/" >> $GITHUB_STEP_SUMMARY
            echo "- **Orlando (Protected)**: http://mb-acws1/2025.1.ORL/" >> $GITHUB_STEP_SUMMARY
            echo "- **GitHub Pages**: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
          fi

  notify-deployment:
    needs: deploy-to-nginx
    runs-on: ubuntu-latest
    if: always()
    
    steps:
      - name: Notify deployment result
        run: |
          if [[ "${{ needs.deploy-to-nginx.result }}" == "success" ]]; then
            echo "‚úÖ Campus Workshop nginx deployment completed successfully!"
            echo "üåê Site is now live at: http://mb-acws1/"
            echo "üõ°Ô∏è Orlando 2025.1.ORL remains protected"
          else
            echo "‚ùå Campus Workshop nginx deployment failed!"
            echo "Please check the deployment logs for details."
          fi
