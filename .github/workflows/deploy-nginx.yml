name: Deploy to Nginx Server

"on":
  push:
    branches: [gh-pages]
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Server hostname or IP'
        required: true
        default: 'acws.duckdns.org'
      force_update:
        description: 'Force update even if no changes'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (test without deploying)'
        type: boolean
        default: false

env:
  SERVER_USER: ubuntu
  SERVER_PATH: /var/www/mkdocs/site
  NGINX_SERVICE: nginx

jobs:
  deploy-to-nginx:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && 'main' || 'gh-pages' }}
          fetch-depth: 0

      - name: Fix ATD Token HTML rendering (for gh-pages)
        if: ${{ github.event_name == 'push' }}
        run: |
          echo "ğŸ”§ Fixing ATD Token HTML rendering for gh-pages deployment..."

          # For gh-pages deployment, we're dealing with built HTML content
          # Check if the ATD lab page exists
          if [ -f "a_wired/a02_atd/index.html" ]; then
            echo "âœ… Found ATD lab page, checking for rendering issues..."

            # Check for various HTML encoding issues and fix them
            FIXED=false

            # Fix HTML entity encoding issues
            if grep -q 'target="_blank&quot;"' a_wired/a02_atd/index.html 2>/dev/null; then
              echo "ğŸ”§ Fixing HTML entity encoding: target=\"_blank&quot;\" â†’ target=\"_blank\""
              find . -name "*.html" -type f -exec sed -i 's/target="_blank&quot;"/target="_blank"/g' {} \; 2>/dev/null || true
              FIXED=true
            fi

            # Fix malformed target attributes
            if grep -q 'target=_blank' a_wired/a02_atd/index.html 2>/dev/null; then
              echo "ğŸ”§ Fixing unquoted target attributes: target=_blank â†’ target=\"_blank\""
              find . -name "*.html" -type f -exec sed -i 's/target=_blank/target="_blank"/g' {} \; 2>/dev/null || true
              FIXED=true
            fi

            # Check if ATD links exist at all
            if grep -q 'testdrive.arista.com' a_wired/a02_atd/index.html 2>/dev/null; then
              echo "âœ… ATD Token links found in HTML"

              # Verify they have proper target attributes
              if grep -q 'target="_blank"' a_wired/a02_atd/index.html 2>/dev/null; then
                echo "âœ… ATD Token links have proper target attributes"
              else
                echo "âš ï¸ ATD Token links missing target attributes"
              fi
            else
              echo "âš ï¸ No ATD Token links found in HTML - this might indicate a CSV processing issue"
            fi

            if [ "$FIXED" = true ]; then
              echo "âœ… HTML rendering issues fixed"
            else
              echo "âœ… No HTML rendering issues found"
            fi
          else
            echo "â„¹ï¸ No ATD lab page found - skipping HTML fixes"
          fi

      - name: Setup Python (for manual builds)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (for manual builds)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Fix ATD Token CSV formatting
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "ğŸ”§ Fixing ATD Token CSV formatting..."

          # Check if CSV file exists
          if [ -f "data/lab_assignment.csv" ]; then
            echo "âœ… Found lab_assignment.csv, applying fixes..."

            # Create a Python script to handle CSV fixes more reliably
            cat > fix_csv.py << 'EOF'
          import csv
          import re

          # Read the CSV file
          with open('data/lab_assignment.csv', 'r', encoding='utf-8') as f:
              content = f.read()

          # Apply fixes
          # Fix double quotes in target attribute
          content = content.replace('""_blank""', '"_blank"')

          # Fix target=_blank without quotes
          content = re.sub(r'target=_blank(?!")', 'target="_blank"', content)

          # Remove unnecessary quote wrapping around entire markdown links
          content = re.sub(r',"(\[ğŸš€ ATD Lab\].*?\})"', r',\1', content)

          # Write back the fixed content
          with open('data/lab_assignment.csv', 'w', encoding='utf-8') as f:
              f.write(content)

          print("âœ… CSV fixes applied successfully")
          EOF

            # Run the Python fix script
            python3 fix_csv.py

            echo "âœ… ATD Token CSV formatting fixed using Python"
            echo "ğŸ” Verifying fix..."
            grep -n "target=" data/lab_assignment.csv | head -3 || echo "No target attributes found"
          else
            echo "â„¹ï¸ No lab_assignment.csv found, skipping ATD Token fix"
          fi

      - name: Build site for nginx deployment
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "Building site for nginx deployment..."
          mkdocs build --clean
          
          echo "Creating versioned structure..."
          mkdir -p deploy_site/2025.4.ATL
          cp -r site/* deploy_site/2025.4.ATL/
          
          echo '[{"version":"2025.4.ATL","title":"Atlanta 2025.4","aliases":["latest"]},{"version":"2025.1.ORL","title":"Orlando 2025.1","aliases":[]}]' > deploy_site/versions.json
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Redirecting...</title><meta http-equiv="refresh" content="0; url=./2025.4.ATL/"></head><body><p>Redirecting to <a href="./2025.4.ATL/">latest version</a>...</p></body></html>' > deploy_site/index.html
          
          echo "Site built successfully"
          ls -la deploy_site/

          # Verify ATD Token links are rendering correctly
          echo "ğŸ” Verifying ATD Token link rendering..."
          if [ -f "deploy_site/2025.4.ATL/a_wired/a02_atd/index.html" ]; then
            if grep -q 'href="https://testdrive.arista.com/topology' deploy_site/2025.4.ATL/a_wired/a02_atd/index.html; then
              echo "âœ… ATD Token links found in built HTML"
              if grep -q 'target="_blank"' deploy_site/2025.4.ATL/a_wired/a02_atd/index.html; then
                echo "âœ… ATD Token links have correct target='_blank' attribute"
              else
                echo "âš ï¸ ATD Token links missing target='_blank' attribute"
              fi
            else
              echo "âš ï¸ No ATD Token links found in built HTML"
            fi
          else
            echo "â„¹ï¸ ATD lab page not found in built site"
          fi

      - name: Deploy to nginx server (detailed diagnostics)
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          set -e
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "ğŸš€ Starting deployment to nginx server: $SERVER_HOST"
          echo "â° Timestamp: $(date)"

          # Setup SSH key with better error handling
          echo "ğŸ”‘ Setting up SSH key..."
          mkdir -p ~/.ssh
          echo "${{ secrets.NGINX_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Add SSH config for better connection handling
          echo "âš™ï¸ Creating SSH config..."
          cat >> ~/.ssh/config << EOF
          Host $SERVER_HOST
            HostName $SERVER_HOST
            User ${{ env.SERVER_USER }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ServerAliveInterval 60
            ServerAliveCountMax 3
            ConnectTimeout 30
          EOF

          # Add to known hosts
          echo "ğŸ” Adding to known hosts..."
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts 2>/dev/null || true

          # Test connection with retry logic
          echo "ğŸ” Testing SSH connection with retry..."
          for i in {1..3}; do
            echo "ğŸ”„ Connection attempt $i/3..."
            if ssh ${{ env.SERVER_USER }}@$SERVER_HOST "echo 'Connection test $i successful'"; then
              echo "âœ… SSH connection established on attempt $i"
              break
            else
              echo "âŒ Connection attempt $i failed, retrying..."
              sleep 5
            fi
            if [ $i -eq 3 ]; then
              echo "ğŸ’¥ All connection attempts failed"
              exit 1
            fi
          done

          # Determine source directory
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SITE_SOURCE="deploy_site"
            echo "ğŸ“ Using built site from: $SITE_SOURCE"
          else
            SITE_SOURCE="."
            echo "ğŸ“ Using gh-pages content from: $SITE_SOURCE"
          fi

          # Check if source directory exists
          echo "ğŸ” Checking source directory..."
          if [ ! -d "$SITE_SOURCE" ]; then
            echo "âŒ Source directory $SITE_SOURCE does not exist!"
            echo "ğŸ“‹ Available directories:"
            ls -la
            exit 1
          fi

          # Create archive
          echo "ğŸ“¦ Creating deployment archive..."
          tar -czf site-deploy.tar.gz -C "$SITE_SOURCE" .
          if [ $? -eq 0 ]; then
            echo "âœ… Archive created: $(ls -lh site-deploy.tar.gz)"
          else
            echo "âŒ Failed to create archive"
            exit 1
          fi

          # Transfer archive with retry
          echo "ğŸ“¤ Transferring archive with retry..."
          for i in {1..3}; do
            echo "ğŸ”„ Transfer attempt $i/3..."
            if scp site-deploy.tar.gz ${{ env.SERVER_USER }}@$SERVER_HOST:/tmp/; then
              echo "âœ… File transfer successful on attempt $i"
              break
            else
              echo "âŒ Transfer attempt $i failed, retrying..."
              sleep 5
            fi
            if [ $i -eq 3 ]; then
              echo "ğŸ’¥ All transfer attempts failed"
              exit 1
            fi
          done

          # Execute deployment with detailed logging
          echo "ğŸ”„ Executing deployment with detailed logging..."
          ssh ${{ env.SERVER_USER }}@$SERVER_HOST 'bash -s' << 'DEPLOY_SCRIPT'
            set -e
            echo "ğŸš€ Starting deployment on server..."
            echo "â° Server timestamp: $(date)"
            echo "ğŸ‘¤ Running as user: $(whoami)"

            # Check if archive exists
            echo "ğŸ” Checking if archive exists..."
            if [ ! -f "/tmp/site-deploy.tar.gz" ]; then
              echo "âŒ Archive not found at /tmp/site-deploy.tar.gz"
              exit 1
            else
              echo "âœ… Archive found: $(ls -lh /tmp/site-deploy.tar.gz)"
            fi

            # Backup Orlando
            echo "ğŸ›¡ï¸ Checking for Orlando backup..."
            if [ -d "/var/www/mkdocs/site/2025.1.ORL" ]; then
              echo "ğŸ“‹ Orlando directory found, creating backup..."
              sudo cp -r "/var/www/mkdocs/site/2025.1.ORL" "/tmp/orlando-backup"
              echo "âœ… Orlando backed up to /tmp/orlando-backup"
            else
              echo "â„¹ï¸ No Orlando directory found to backup"
            fi

            # Create temp directory and extract
            echo "ğŸ“ Creating temp directory and extracting..."
            rm -rf /tmp/deploy-temp
            mkdir -p /tmp/deploy-temp
            cd /tmp/deploy-temp
            echo "ğŸ“¦ Extracting archive..."
            tar -xzf /tmp/site-deploy.tar.gz
            if [ $? -eq 0 ]; then
              echo "âœ… Archive extracted successfully"
              echo "ğŸ“‹ Extracted contents:"
              ls -la
            else
              echo "âŒ Failed to extract archive"
              exit 1
            fi

            # Deploy to final location
            echo "ğŸš€ Deploying to final location..."
            sudo mkdir -p /var/www/mkdocs/site
            echo "ğŸ“ Copying files to /var/www/mkdocs/site/..."
            sudo cp -r . /var/www/mkdocs/site/
            if [ $? -eq 0 ]; then
              echo "âœ… Files copied successfully"
            else
              echo "âŒ Failed to copy files"
              exit 1
            fi

            # Restore Orlando
            echo "ğŸ›¡ï¸ Restoring Orlando if backup exists..."
            if [ -d "/tmp/orlando-backup" ]; then
              echo "ğŸ“‹ Restoring Orlando from backup..."
              sudo cp -r "/tmp/orlando-backup" "/var/www/mkdocs/site/2025.1.ORL"
              rm -rf /tmp/orlando-backup
              echo "âœ… Orlando restored successfully"
            else
              echo "â„¹ï¸ No Orlando backup to restore"
            fi

            # Set permissions
            echo "ğŸ” Setting permissions..."
            sudo chown -R www-data:www-data /var/www/mkdocs/site
            sudo chmod -R 755 /var/www/mkdocs/site
            echo "âœ… Permissions set successfully"

            # Reload nginx
            echo "ğŸ”„ Reloading nginx..."
            sudo systemctl reload nginx
            if [ $? -eq 0 ]; then
              echo "âœ… Nginx reloaded successfully"
            else
              echo "âŒ Failed to reload nginx"
              exit 1
            fi

            # Cleanup
            echo "ğŸ§¹ Cleaning up..."
            rm -rf /tmp/deploy-temp /tmp/site-deploy.tar.gz
            echo "âœ… Cleanup completed"

            echo "ğŸ‰ Deployment completed successfully!"
            echo "â° Completion timestamp: $(date)"
          DEPLOY_SCRIPT

          echo "ğŸ‰ Deployment finished successfully!"
          echo "â° Local completion timestamp: $(date)"

      - name: Dry run simulation
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "DRY RUN: Would deploy to ${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "Orlando 2025.1.ORL would be preserved"
          echo "Dry run completed"

      - name: Deployment summary
        run: |
          echo "Campus Workshop deployment completed!"
          echo "Site: http://${{ github.event.inputs.server_host || 'acws.duckdns.org' }}/"
          echo "Orlando 2025.1.ORL protected"
