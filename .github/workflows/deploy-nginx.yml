name: Deploy to Nginx Server

"on":
  push:
    branches: [gh-pages]
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Server hostname or IP'
        required: true
        default: 'acws.duckdns.org'
      force_update:
        description: 'Force update even if no changes'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (test without deploying)'
        type: boolean
        default: false

env:
  SERVER_USER: ubuntu
  SERVER_PATH: /var/www/mkdocs/site
  NGINX_SERVICE: nginx

jobs:
  deploy-to-nginx:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && 'main' || 'gh-pages' }}
          fetch-depth: 0

      - name: Setup Python (for manual builds)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (for manual builds)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build site for nginx deployment
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üî® Building site for nginx deployment..."
          mkdocs build --clean
          
          echo "üì¶ Creating versioned structure..."
          mkdir -p deploy_site/2025.4.ATL
          cp -r site/* deploy_site/2025.4.ATL/
          
          echo '[{"version":"2025.4.ATL","title":"Atlanta 2025.4","aliases":["latest"]},{"version":"2025.1.ORL","title":"Orlando 2025.1","aliases":[]}]' > deploy_site/versions.json
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Redirecting...</title><meta http-equiv="refresh" content="0; url=./2025.4.ATL/"></head><body><p>Redirecting to <a href="./2025.4.ATL/">latest version</a>...</p></body></html>' > deploy_site/index.html
          
          echo "‚úÖ Site built successfully"
          ls -la deploy_site/

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.NGINX_SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

      - name: Test server connection
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üîó Testing connection to $SERVER_HOST..."
          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "echo 'Connection successful'"

      - name: Deploy to nginx server
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üöÄ Deploying to nginx server: $SERVER_HOST"

          # Determine source directory
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            SITE_SOURCE="deploy_site"
            echo "üì¶ Using built site from: $SITE_SOURCE"
          else
            SITE_SOURCE="."
            echo "üì¶ Using gh-pages content from: $SITE_SOURCE"
          fi

          # Create deployment archive
          echo "üì¶ Creating deployment archive..."
          tar -czf site.tar.gz -C "$SITE_SOURCE" .

          # Transfer to server
          echo "üì§ Transferring to server..."
          scp site.tar.gz ${{ env.SERVER_USER }}@$SERVER_HOST:/tmp/

          # Create deployment script with proper variable substitution
          cat > deploy_script.sh << DEPLOY_EOF
          #!/bin/bash
          set -e

          echo "üîÑ Deploying on server..."

          # Backup Orlando if it exists
          if [ -d "${{ env.SERVER_PATH }}/2025.1.ORL" ]; then
            echo "üõ°Ô∏è Backing up Orlando version..."
            sudo cp -r "${{ env.SERVER_PATH }}/2025.1.ORL" "/tmp/orlando-backup-\$(date +%s)"
          fi

          # Create target directory
          sudo mkdir -p "${{ env.SERVER_PATH }}"

          # Extract new site
          cd /tmp
          rm -rf new-site
          mkdir -p new-site
          cd new-site
          tar -xzf /tmp/site.tar.gz

          # Deploy new content (excluding Orlando)
          echo "üì¶ Deploying new content..."
          sudo rsync -av --exclude="2025.1.ORL" /tmp/new-site/ "${{ env.SERVER_PATH }}/"

          # Restore Orlando if we backed it up
          ORLANDO_BACKUP=\$(ls -t /tmp/orlando-backup-* 2>/dev/null | head -1 || echo "")
          if [ -n "\$ORLANDO_BACKUP" ] && [ -d "\$ORLANDO_BACKUP" ]; then
            echo "üõ°Ô∏è Restoring Orlando version..."
            sudo cp -r "\$ORLANDO_BACKUP" "${{ env.SERVER_PATH }}/2025.1.ORL"
          fi

          # Set permissions
          sudo chown -R www-data:www-data "${{ env.SERVER_PATH }}"
          sudo chmod -R 755 "${{ env.SERVER_PATH }}"

          # Reload nginx
          sudo systemctl reload nginx

          # Cleanup
          rm -rf /tmp/new-site /tmp/site.tar.gz /tmp/orlando-backup-*

          echo "‚úÖ Deployment completed successfully"
          DEPLOY_EOF

          # Transfer and execute deployment script
          scp deploy_script.sh ${{ env.SERVER_USER }}@$SERVER_HOST:/tmp/
          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "chmod +x /tmp/deploy_script.sh && /tmp/deploy_script.sh && rm /tmp/deploy_script.sh"

      - name: Dry run simulation
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "üß™ DRY RUN: Would deploy to ${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üõ°Ô∏è Orlando 2025.1.ORL would be preserved"
          echo "‚úÖ Dry run completed"

      - name: Deployment summary
        run: |
          echo "‚úÖ Campus Workshop deployment completed!"
          echo "üåê Site: http://${{ github.event.inputs.server_host || 'acws.duckdns.org' }}/"
          echo "üõ°Ô∏è Orlando 2025.1.ORL protected"
