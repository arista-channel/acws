# Deploy Campus Workshop to Nginx Server
name: Deploy to Nginx Server

"on":
  # Automatic deployment when GitHub Pages is updated
  push:
    branches: [gh-pages]

  # Manual trigger for nginx deployment (with options)
  workflow_dispatch:
    inputs:
      server_host:
        description: 'Server hostname or IP'
        required: true
        default: 'acws.duckdns.org'
      force_update:
        description: 'Force update even if no changes'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run (test without deploying)'
        type: boolean
        default: false

env:
  SERVER_USER: ubuntu
  SERVER_PATH: /var/www/mkdocs/site
  NGINX_SERVICE: nginx

jobs:
  deploy-to-nginx:
    runs-on: ubuntu-latest
    # Run for both automatic (push to gh-pages) and manual (workflow_dispatch) triggers
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'push' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # For manual dispatch from main, checkout main branch
          # For automatic gh-pages push, checkout gh-pages branch
          ref: ${{ github.event_name == 'workflow_dispatch' && 'main' || 'gh-pages' }}
          fetch-depth: 0

      # Build site if triggered manually from main branch
      - name: Setup Python (for manual builds)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies (for manual builds)
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build site for nginx deployment
        if: ${{ github.event_name == 'workflow_dispatch' }}
        run: |
          echo "üî® Building site for nginx deployment..."

          # Build the site with MkDocs
          mkdocs build --clean

          # Create Mike-style directory structure
          echo "üì¶ Creating Mike-style versioned structure..."
          mkdir -p deploy_site/2025.4.ATL
          cp -r site/* deploy_site/2025.4.ATL/

          # Create versions.json for Mike compatibility
          echo '[{"version":"2025.4.ATL","title":"Atlanta 2025.4","aliases":["latest"]},{"version":"2025.1.ORL","title":"Orlando 2025.1","aliases":[]}]' > deploy_site/versions.json

          # Create main index.html that redirects to latest version
          echo '<!DOCTYPE html><html><head><meta charset="utf-8"><title>Redirecting...</title><meta http-equiv="refresh" content="0; url=./2025.4.ATL/"><link rel="canonical" href="./2025.4.ATL/"></head><body><p>Redirecting to <a href="./2025.4.ATL/">latest version</a>...</p></body></html>' > deploy_site/index.html

          echo "‚úÖ Site built successfully"
          echo "üìÅ Deploy structure:"
          ls -la deploy_site/
          echo "üìÅ Atlanta version:"
          ls -la deploy_site/2025.4.ATL/ | head -5

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.NGINX_SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          ssh-keyscan -H $SERVER_HOST >> ~/.ssh/known_hosts

      - name: Check server connectivity
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üîó Testing connection to $SERVER_HOST..."
          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "echo 'Connection successful to Campus Workshop server'"

      - name: Backup existing site (if present)
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üíæ Checking for existing site to backup..."
          echo "üéØ Target: ${{ env.SERVER_PATH }}"

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            if [ -d '${{ env.SERVER_PATH }}' ]; then
              echo '‚úÖ Existing site found: ${{ env.SERVER_PATH }}'

              # Create timestamped backup
              BACKUP_DIR='${{ env.SERVER_PATH }}.backup.$(date +%Y%m%d_%H%M%S)'
              echo \"üì¶ Creating backup: \$BACKUP_DIR\"
              sudo cp -r '${{ env.SERVER_PATH }}' \"\$BACKUP_DIR\"

              # Verify backup
              if [ -d \"\$BACKUP_DIR\" ]; then
                echo '‚úÖ Backup created successfully'
                echo \"üìä Backup size: \$(sudo du -sh \$BACKUP_DIR | cut -f1)\"
              else
                echo '‚ö†Ô∏è Backup creation failed, but continuing deployment'
              fi
            else
              echo 'üìù No existing site found at ${{ env.SERVER_PATH }}'
              echo 'üöÄ This appears to be a fresh deployment'

              # Create the directory structure
              echo 'üìÅ Creating directory structure...'
              sudo mkdir -p '${{ env.SERVER_PATH }}'
              sudo chown -R www-data:www-data '${{ env.SERVER_PATH }}'
            fi
          "

      - name: Deploy built site to nginx server
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "ÔøΩ Deploying site to nginx server: $SERVER_HOST"
          echo "üéØ Target: ${{ env.SERVER_PATH }}"
          echo "üõ°Ô∏è Orlando 2025.1.ORL will be preserved"

          # For manual builds, we have the site built in the 'deploy_site' directory
          # For gh-pages pushes, we use the current directory content
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "üì¶ Manual build: Using deploy_site directory"
            SITE_SOURCE="deploy_site"
            if [ ! -d "$SITE_SOURCE" ]; then
              echo "‚ùå Deploy site directory not found!"
              echo "Available directories:"
              ls -la
              exit 1
            fi
          else
            echo "üì¶ Automatic deployment: Using gh-pages content"
            SITE_SOURCE="."
          fi

          # Create a tarball of the site for transfer
          echo "üì¶ Creating site archive from: $SITE_SOURCE"
          echo "üìÅ Contents of $SITE_SOURCE:"
          ls -la "$SITE_SOURCE" | head -10
          tar -czf site.tar.gz -C "$SITE_SOURCE" .

          # Transfer and deploy
          echo "üì§ Transferring site to server..."
          scp site.tar.gz ${{ env.SERVER_USER }}@$SERVER_HOST:/tmp/

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            echo 'üîÑ Deploying site on server...'

            # Backup Orlando version if it exists
            if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
              echo 'üõ°Ô∏è Backing up Orlando version...'
              sudo cp -r '${{ env.SERVER_PATH }}/2025.1.ORL' '/tmp/orlando-backup-\$(date +%s)'
            fi

            # Create temporary directory for new site
            TEMP_SITE='/tmp/new-site-\$(date +%s)'
            mkdir -p \"\$TEMP_SITE\"

            # Extract new site
            cd \"\$TEMP_SITE\"
            tar -xzf /tmp/site.tar.gz

            # Deploy new site (preserve Orlando)
            echo 'ÔøΩ Deploying new site content...'
            sudo rsync -av --exclude='2025.1.ORL' \"\$TEMP_SITE/\" '${{ env.SERVER_PATH }}/'

            # Restore Orlando if we backed it up
            if [ -d '/tmp/orlando-backup-'* ]; then
              echo 'üõ°Ô∏è Restoring Orlando version...'
              ORLANDO_BACKUP=\$(ls -t /tmp/orlando-backup-* | head -1)
              sudo cp -r \"\$ORLANDO_BACKUP\" '${{ env.SERVER_PATH }}/2025.1.ORL'
            fi

            # Set proper permissions
            sudo chown -R www-data:www-data '${{ env.SERVER_PATH }}'
            sudo chmod -R 755 '${{ env.SERVER_PATH }}'

            # Cleanup
            rm -rf \"\$TEMP_SITE\" /tmp/site.tar.gz

            echo '‚úÖ Site deployed successfully'
          "

      - name: Dry run simulation
        if: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run == 'true' }}
        run: |
          echo "üß™ DRY RUN: Would deploy site to nginx server"
          echo "üéØ Target: ${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "üõ°Ô∏è Orlando 2025.1.ORL would be preserved"
          echo "‚úÖ Dry run complete - no actual deployment performed"

      - name: Reload nginx and verify deployment
        if: ${{ github.event_name == 'push' || (github.event_name == 'workflow_dispatch' && github.event.inputs.dry_run != 'true') }}
        run: |
          SERVER_HOST="${{ github.event.inputs.server_host || 'acws.duckdns.org' }}"
          echo "ÔøΩ Reloading nginx and verifying deployment..."

          ssh ${{ env.SERVER_USER }}@$SERVER_HOST "
            # Reload nginx
            sudo systemctl reload ${{ env.NGINX_SERVICE }}
            echo '‚úÖ Nginx reloaded'

            # Verify Orlando protection
            if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
              echo 'üõ°Ô∏è ‚úÖ Orlando 2025.1.ORL is protected and intact'
            else
              echo 'üõ°Ô∏è ‚ö†Ô∏è Orlando version not found'
            fi

            # Test site accessibility
            HTTP_CODE=\$(curl -s -o /dev/null -w '%{http_code}' http://localhost/)
            if [ \"\$HTTP_CODE\" = '200' ]; then
              echo \"‚úÖ Site is accessible (HTTP \$HTTP_CODE)\"
            else
              echo \"‚ö†Ô∏è Site returned HTTP \$HTTP_CODE\"
            fi
          "

      - name: Deployment summary
        run: |
          echo "‚úÖ Campus Workshop nginx deployment completed!"
          echo "üåê Site: http://acws.duckdns.org/"
          echo "üõ°Ô∏è Orlando 2025.1.ORL protected"
