name: ğŸš€ Automated Campus Workshop Update

on:
  push:
    branches: [main]
    paths:
      - 'docs/**'
      - 'data/**'
      - 'mkdocs.yml'
      - 'requirements.txt'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes detected'
        type: boolean
        default: false
      skip_orlando_protection:
        description: 'Skip Orlando protection (DANGEROUS - use only if Orlando is corrupted)'
        type: boolean
        default: false
      dry_run:
        description: 'Dry run - test without actual deployment'
        type: boolean
        default: false

env:
  SERVER_HOST: acws.duckdns.org
  SERVER_IP: 3.148.13.216
  SERVER_USER: ubuntu
  SERVER_PATH: /var/www/mkdocs/site
  PYTHON_VERSION: '3.11'
  UV_VERSION: '0.4.18'

jobs:
  # Job 1: Build and Deploy to GitHub Pages
  build-and-deploy-pages:
    name: ğŸ“¦ Build & Deploy to GitHub Pages
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    outputs:
      deployment-id: ${{ steps.deployment.outputs.deployment_id }}
      pages-url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python with UV
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ Install UV Package Manager
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: ğŸ“¦ Install Dependencies with UV
        run: |
          uv venv
          source .venv/bin/activate
          uv pip install -r requirements.txt

      - name: ğŸ”§ Configure Git for Mike
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          git config --global init.defaultBranch main

      - name: ğŸ”§ Fix ATD Token CSV Issues
        run: |
          source .venv/bin/activate
          echo "ğŸ”§ Applying ATD Token CSV fixes..."
          
          # Create comprehensive CSV fix script
          cat > fix_atd_tokens.py << 'EOF'
          import csv
          import re
          import sys
          
          def fix_csv_file(filepath):
              print(f"ğŸ” Processing {filepath}...")
              
              try:
                  with open(filepath, 'r', encoding='utf-8') as f:
                      content = f.read()
                  
                  original_content = content
                  
                  # Fix 1: Double quotes in target attribute
                  content = content.replace('""_blank""', '"_blank"')
                  
                  # Fix 2: Unquoted target attributes
                  content = re.sub(r'target=_blank(?!")', 'target="_blank"', content)
                  
                  # Fix 3: Remove unnecessary quote wrapping around markdown links
                  content = re.sub(r',"(\[ğŸš€ ATD Lab.*?\})"', r',\1', content)
                  
                  # Fix 4: Ensure proper markdown link format
                  content = re.sub(r'\[ğŸš€ ATD Lab (\d+)\]\((https://testdrive\.arista\.com/[^)]+)\)\{:target="_blank"\}', 
                                 r'[ğŸš€ ATD Lab \1](\2){:target="_blank"}', content)
                  
                  if content != original_content:
                      with open(filepath, 'w', encoding='utf-8') as f:
                          f.write(content)
                      print("âœ… CSV fixes applied successfully")
                      
                      # Verify fixes
                      with open(filepath, 'r', encoding='utf-8') as f:
                          lines = f.readlines()
                      
                      atd_count = sum(1 for line in lines if 'ğŸš€ ATD Lab' in line and 'testdrive.arista.com' in line)
                      print(f"âœ… Found {atd_count} ATD Lab entries")
                      
                      target_blank_count = sum(1 for line in lines if 'target="_blank"' in line)
                      print(f"âœ… Found {target_blank_count} properly formatted target attributes")
                      
                  else:
                      print("âœ… No CSV fixes needed")
                      
              except Exception as e:
                  print(f"âŒ Error processing CSV: {e}")
                  sys.exit(1)
          
          if __name__ == "__main__":
              fix_csv_file("data/lab_assignment.csv")
          EOF
          
          python fix_atd_tokens.py

      - name: ğŸ—ï¸ Build Documentation with Mike
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          source .venv/bin/activate
          echo "ğŸ—ï¸ Building documentation with Mike versioning..."

          # Clean any existing builds
          rm -rf site/

          # Configure git remote with token for Mike
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git

          # Comprehensive gh-pages branch handling
          echo "ğŸ”„ Handling gh-pages branch conflicts..."

          # Fetch all branches
          git fetch origin --prune

          # Reset gh-pages branch to avoid conflicts
          if git ls-remote --exit-code --heads origin gh-pages >/dev/null 2>&1; then
            echo "ğŸ“‹ Remote gh-pages branch exists, syncing..."
            git branch -D gh-pages 2>/dev/null || true
            git checkout -b gh-pages origin/gh-pages
            git checkout main
          else
            echo "ğŸ“‹ No remote gh-pages branch found"
          fi

          # Deploy with Mike using ignore-remote-status to handle conflicts
          echo "ğŸš€ Deploying with Mike (ignoring remote status)..."
          mike deploy --push --update-aliases --ignore-remote-status 2025.4.ATL latest || {
            echo "âš ï¸ Mike deploy with ignore-remote-status failed, trying manual approach..."

            # Manual approach: deploy locally, then force push
            echo "ğŸ”„ Deploying locally without push..."
            mike deploy --update-aliases 2025.4.ATL latest

            echo "ğŸ”„ Manually pushing to gh-pages with force..."
            git checkout gh-pages
            git add .
            git commit -m "Deploy documentation with Mike versioning" || echo "No changes to commit"
            git push origin gh-pages --force
            git checkout main
            echo "âœ… Manual deployment completed"
          }

          # Verify Mike structure (from main branch with remote gh-pages)
          echo "ğŸ“‹ Mike versions after deployment:"
          git fetch origin gh-pages
          mike list --remote origin --branch gh-pages

          echo "âœ… Documentation built and deployed successfully"

      - name: ğŸ” Verify ATD Token Rendering
        run: |
          source .venv/bin/activate
          echo "ğŸ” Verifying ATD Token rendering in built site..."
          
          # Check if ATD page exists in the built site
          if [ -f "2025.4.ATL/a_wired/a02_atd/index.html" ]; then
            echo "âœ… ATD lab page found"
            
            # Count ATD Token links
            atd_links=$(grep -c 'href="https://testdrive.arista.com' 2025.4.ATL/a_wired/a02_atd/index.html || echo "0")
            echo "ğŸ“Š Found $atd_links ATD Token links"
            
            # Check target attributes
            target_attrs=$(grep -c 'target="_blank"' 2025.4.ATL/a_wired/a02_atd/index.html || echo "0")
            echo "ğŸ“Š Found $target_attrs target='_blank' attributes"
            
            if [ "$atd_links" -gt "0" ] && [ "$target_attrs" -gt "0" ]; then
              echo "âœ… ATD Token links are properly rendered"
            else
              echo "âš ï¸ ATD Token links may have rendering issues"
              echo "ğŸ” Sample of ATD content:"
              grep -A2 -B2 "ATD Lab" 2025.4.ATL/a_wired/a02_atd/index.html | head -10 || echo "No ATD Lab content found"
            fi
          else
            echo "âš ï¸ ATD lab page not found in built site"
            echo "ğŸ“‹ Available pages:"
            find . -name "index.html" | head -10
          fi

      - name: ğŸ“¤ Verify GitHub Pages Deployment
        id: deployment
        run: |
          source .venv/bin/activate
          echo "ğŸ“¤ Mike has deployed to GitHub Pages automatically"
          echo "ğŸ” Verifying deployment..."

          # Get the latest commit on gh-pages
          git fetch origin gh-pages
          latest_commit=$(git rev-parse origin/gh-pages)
          echo "ğŸ“‹ Latest gh-pages commit: $latest_commit"

          # Verify deployment structure (using git show to check files on gh-pages)
          echo "ğŸ“‹ Deployment structure verification:"

          # Check if files exist on gh-pages branch without switching to it
          if git show origin/gh-pages:index.html >/dev/null 2>&1; then
            echo "âœ… Root index.html exists on gh-pages"
          else
            echo "âŒ Root index.html missing on gh-pages"
          fi

          if git show origin/gh-pages:versions.json >/dev/null 2>&1; then
            echo "âœ… versions.json exists on gh-pages"
            echo "ğŸ“‹ Available versions:"
            git show origin/gh-pages:versions.json | grep -o '"version":"[^"]*"' | cut -d'"' -f4 || echo "Cannot parse versions"
          else
            echo "âŒ versions.json missing on gh-pages"
          fi

          # Check if Atlanta directory exists
          if git ls-tree origin/gh-pages | grep -q "2025.4.ATL"; then
            echo "âœ… Atlanta 2025.4.ATL directory exists on gh-pages"
          else
            echo "âŒ Atlanta 2025.4.ATL directory missing on gh-pages"
          fi

          # Set outputs for next job
          echo "deployment_id=$latest_commit" >> $GITHUB_OUTPUT
          echo "page_url=https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_OUTPUT

          echo "âœ… GitHub Pages deployment verified"

  # Job 2: Deploy to Nginx Server
  deploy-to-nginx:
    name: ğŸŒ Deploy to Nginx Server
    runs-on: ubuntu-latest
    permissions:
      contents: read
    needs: build-and-deploy-pages
    if: ${{ !cancelled() && (success() || github.event.inputs.force_deploy == 'true') }}
    
    steps:
      - name: ğŸ” Checkout gh-pages Branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          fetch-depth: 1

      - name: ğŸ”§ Pre-deployment Validation
        run: |
          echo "ğŸ” Validating deployment package..."
          
          # Check required files
          required_files=("index.html" "versions.json")
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              echo "âœ… Found required file: $file"
            else
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
          
          # Check version directories
          if [ -d "2025.4.ATL" ]; then
            echo "âœ… Found Atlanta version directory"
          else
            echo "âŒ Missing Atlanta version directory"
            exit 1
          fi
          
          # Verify index.html redirect
          if grep -q "2025.4.ATL" index.html; then
            echo "âœ… Index.html contains proper redirect"
          else
            echo "âŒ Index.html missing proper redirect"
            exit 1
          fi
          
          echo "âœ… Pre-deployment validation passed"

      - name: ğŸ“¦ Create Deployment Package
        run: |
          echo "ğŸ“¦ Creating optimized deployment package..."
          
          # Create clean deployment directory
          mkdir -p deployment-package
          
          # Copy essential files with proper structure
          cp index.html deployment-package/
          cp versions.json deployment-package/
          
          # Copy version directories (excluding unnecessary files)
          if [ -d "2025.4.ATL" ]; then
            echo "ğŸ“ Copying Atlanta 2025.4.ATL..."
            cp -r 2025.4.ATL deployment-package/
          fi
          
          # Create archive with better compression
          echo "ğŸ—œï¸ Creating compressed archive..."
          tar -czf nginx-deployment.tar.gz -C deployment-package .
          
          # Verify archive
          archive_size=$(ls -lh nginx-deployment.tar.gz | awk '{print $5}')
          echo "âœ… Deployment package created: $archive_size"
          
          # Test archive integrity
          if tar -tzf nginx-deployment.tar.gz > /dev/null 2>&1; then
            echo "âœ… Archive integrity verified"
          else
            echo "âŒ Archive integrity check failed"
            exit 1
          fi

      - name: ğŸš€ Deploy to Nginx Server
        if: ${{ github.event.inputs.dry_run != 'true' }}
        run: |
          set -e
          echo "ğŸš€ Starting nginx deployment..."
          echo "â° Deployment started: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # Setup SSH with enhanced security
          echo "ğŸ” Setting up secure SSH connection..."
          mkdir -p ~/.ssh
          echo "${{ secrets.NGINX_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Enhanced SSH config
          cat > ~/.ssh/config << EOF
          Host ${{ env.SERVER_HOST }}
            HostName ${{ env.SERVER_HOST }}
            User ${{ env.SERVER_USER }}
            IdentityFile ~/.ssh/id_rsa
            StrictHostKeyChecking no
            UserKnownHostsFile /dev/null
            ServerAliveInterval 30
            ServerAliveCountMax 3
            ConnectTimeout 10
            BatchMode yes
          EOF
          
          # Test DNS resolution first
          echo "ğŸ” Testing DNS resolution..."
          if ! nslookup ${{ env.SERVER_HOST }} >/dev/null 2>&1; then
            echo "âš ï¸ DNS resolution failed, trying alternative DNS servers..."

            # Try with Google DNS
            echo "ğŸ”„ Trying with Google DNS (8.8.8.8)..."
            if nslookup ${{ env.SERVER_HOST }} 8.8.8.8 >/dev/null 2>&1; then
              echo "âœ… DNS resolution successful with Google DNS"
            else
              echo "ğŸ”„ Trying with Cloudflare DNS (1.1.1.1)..."
              if nslookup ${{ env.SERVER_HOST }} 1.1.1.1 >/dev/null 2>&1; then
                echo "âœ… DNS resolution successful with Cloudflare DNS"
              else
                echo "âŒ DNS resolution failed with all DNS servers"
                echo "ğŸ” DNS troubleshooting info:"
                echo "  - Hostname: ${{ env.SERVER_HOST }}"
                echo "  - Current DNS servers:"
                cat /etc/resolv.conf || echo "Cannot read /etc/resolv.conf"
                echo "  - Network connectivity test:"
                ping -c 1 8.8.8.8 >/dev/null 2>&1 && echo "  âœ… Internet connectivity OK" || echo "  âŒ No internet connectivity"
                exit 1
              fi
            fi
          else
            echo "âœ… DNS resolution successful"
          fi

          # Test connection with timeout and retry (hostname first, then IP fallback)
          echo "ğŸ” Testing server connection..."
          CONNECTION_SUCCESS=false

          # Try with hostname first
          for attempt in {1..2}; do
            echo "ğŸ”„ Connection attempt $attempt/2 using hostname (${{ env.SERVER_HOST }})..."
            if timeout 30 ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} "echo 'Connection successful: $(date)'" 2>/dev/null; then
              echo "âœ… Server connection successful using hostname on attempt $attempt"
              CONNECTION_SUCCESS=true
              break
            else
              echo "âŒ Hostname connection attempt $attempt failed"
              if [ $attempt -lt 2 ]; then
                echo "â³ Waiting 5 seconds before retry..."
                sleep 5
              fi
            fi
          done

          # If hostname failed, try IP address
          if [ "$CONNECTION_SUCCESS" = false ]; then
            echo "ğŸ”„ Trying connection with IP address (${{ env.SERVER_IP }})..."
            for attempt in {1..2}; do
              echo "ğŸ”„ IP connection attempt $attempt/2..."
              if timeout 30 ssh ${{ env.SERVER_USER }}@${{ env.SERVER_IP }} "echo 'Connection successful via IP: $(date)'" 2>/dev/null; then
                echo "âœ… Server connection successful using IP address on attempt $attempt"
                echo "â„¹ï¸ Using IP address for remaining operations due to DNS issues"
                # Update SERVER_HOST to use IP for remaining operations
                echo "SERVER_HOST=${{ env.SERVER_IP }}" >> $GITHUB_ENV
                CONNECTION_SUCCESS=true
                break
              else
                echo "âŒ IP connection attempt $attempt failed"
                if [ $attempt -lt 2 ]; then
                  echo "â³ Waiting 5 seconds before retry..."
                  sleep 5
                fi
              fi
            done
          fi

          # Final check
          if [ "$CONNECTION_SUCCESS" = false ]; then
            echo "ğŸ’¥ All connection attempts failed (both hostname and IP)"
            echo "ğŸ” Connection troubleshooting info:"
            echo "  - Hostname: ${{ env.SERVER_HOST }}"
            echo "  - IP Address: ${{ env.SERVER_IP }}"
            echo "  - User: ${{ env.SERVER_USER }}"
            echo "  - SSH key configured: $([ -f ~/.ssh/id_rsa ] && echo "YES" || echo "NO")"
            echo "  - SSH key permissions: $([ -f ~/.ssh/id_rsa ] && stat -c "%a" ~/.ssh/id_rsa || echo "N/A")"
            echo "  - Network test to hostname:"
            nc -zv ${{ env.SERVER_HOST }} 22 2>&1 || echo "    Cannot connect to hostname SSH port"
            echo "  - Network test to IP:"
            nc -zv ${{ env.SERVER_IP }} 22 2>&1 || echo "    Cannot connect to IP SSH port"
            exit 1
          fi
          
          # Transfer with progress and retry
          echo "ğŸ“¤ Transferring deployment package..."
          for attempt in {1..3}; do
            echo "ğŸ”„ Transfer attempt $attempt/3..."
            if timeout 300 scp -o ConnectTimeout=10 nginx-deployment.tar.gz ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }}:/tmp/; then
              echo "âœ… Transfer successful on attempt $attempt"
              break
            else
              echo "âŒ Transfer attempt $attempt failed"
              if [ $attempt -eq 3 ]; then
                echo "ğŸ’¥ All transfer attempts failed"
                exit 1
              fi
              sleep 10
            fi
          done
          
          # Execute deployment with comprehensive error handling
          echo "ğŸ”„ Executing server-side deployment..."
          ssh ${{ env.SERVER_USER }}@${{ env.SERVER_HOST }} 'bash -s' << 'DEPLOY_SCRIPT'
            set -e
            
            # Deployment configuration
            DEPLOY_TIMESTAMP=$(date -u '+%Y%m%d_%H%M%S')
            BACKUP_DIR="/tmp/nginx_backup_${DEPLOY_TIMESTAMP}"
            TEMP_DIR="/tmp/nginx_deploy_${DEPLOY_TIMESTAMP}"
            SITE_DIR="/var/www/mkdocs/site"
            
            echo "ğŸš€ Server-side deployment started: $(date)"
            echo "ğŸ“‹ Deployment ID: $DEPLOY_TIMESTAMP"
            
            # Pre-deployment checks
            echo "ğŸ” Pre-deployment system checks..."
            
            # Check disk space (need at least 2GB free)
            available_space=$(df /var/www | tail -1 | awk '{print $4}')
            if [ "$available_space" -lt 2097152 ]; then  # 2GB in KB
              echo "âŒ Insufficient disk space: ${available_space}KB available"
              exit 1
            fi
            echo "âœ… Sufficient disk space: ${available_space}KB available"
            
            # Check if nginx is running
            if systemctl is-active --quiet nginx; then
              echo "âœ… Nginx is running"
            else
              echo "âš ï¸ Nginx is not running, attempting to start..."
              sudo systemctl start nginx || {
                echo "âŒ Failed to start nginx"
                exit 1
              }
            fi
            
            # Verify archive exists
            if [ ! -f "/tmp/nginx-deployment.tar.gz" ]; then
              echo "âŒ Deployment archive not found"
              exit 1
            fi
            echo "âœ… Deployment archive verified: $(ls -lh /tmp/nginx-deployment.tar.gz)"
            
            # Create comprehensive backup
            echo "ğŸ’¾ Creating comprehensive backup..."
            sudo mkdir -p "$BACKUP_DIR"
            if [ -d "$SITE_DIR" ]; then
              sudo cp -r "$SITE_DIR" "$BACKUP_DIR/site_backup"
              echo "âœ… Site backup created at $BACKUP_DIR"
            else
              echo "â„¹ï¸ No existing site to backup"
            fi
            
            # Special Orlando protection
            ORLANDO_PROTECTED=false
            if [ -d "$SITE_DIR/2025.1.ORL" ] && [ "${{ github.event.inputs.skip_orlando_protection }}" != "true" ]; then
              echo "ğŸ›¡ï¸ Orlando protection: Backing up 2025.1.ORL..."
              sudo cp -r "$SITE_DIR/2025.1.ORL" "/tmp/orlando_protected_${DEPLOY_TIMESTAMP}"
              ORLANDO_PROTECTED=true
              echo "âœ… Orlando protected at /tmp/orlando_protected_${DEPLOY_TIMESTAMP}"
            fi
            
            # Extract deployment package
            echo "ğŸ“¦ Extracting deployment package..."
            rm -rf "$TEMP_DIR"
            mkdir -p "$TEMP_DIR"
            cd "$TEMP_DIR"
            tar -xzf /tmp/nginx-deployment.tar.gz
            
            # Validate extracted content
            echo "ğŸ” Validating extracted content..."
            if [ ! -f "index.html" ] || [ ! -f "versions.json" ] || [ ! -d "2025.4.ATL" ]; then
              echo "âŒ Invalid deployment package structure"
              exit 1
            fi
            echo "âœ… Deployment package structure validated"
            
            # Atomic deployment
            echo "âš¡ Performing atomic deployment..."
            sudo mkdir -p "$SITE_DIR"
            
            # Clear existing content (except Orlando if protected)
            if [ "$ORLANDO_PROTECTED" = true ]; then
              echo "ğŸ›¡ï¸ Clearing site while preserving Orlando..."
              sudo find "$SITE_DIR" -mindepth 1 -maxdepth 1 ! -name "2025.1.ORL" -exec rm -rf {} \; 2>/dev/null || true
            else
              echo "ğŸ§¹ Clearing entire site directory..."
              sudo rm -rf "$SITE_DIR"/*
            fi
            
            # Deploy new content
            echo "ğŸš€ Deploying new content..."
            sudo cp -r . "$SITE_DIR/"
            
            # Restore Orlando if it was protected
            if [ "$ORLANDO_PROTECTED" = true ]; then
              echo "ğŸ›¡ï¸ Restoring protected Orlando..."
              sudo cp -r "/tmp/orlando_protected_${DEPLOY_TIMESTAMP}" "$SITE_DIR/2025.1.ORL"
              sudo rm -rf "/tmp/orlando_protected_${DEPLOY_TIMESTAMP}"
              echo "âœ… Orlando restored successfully"
            fi
            
            # Set proper permissions
            echo "ğŸ” Setting proper permissions..."
            sudo chown -R www-data:www-data "$SITE_DIR"
            sudo chmod -R 755 "$SITE_DIR"
            
            # Test nginx configuration
            echo "ğŸ”§ Testing nginx configuration..."
            sudo nginx -t || {
              echo "âŒ Nginx configuration test failed"
              exit 1
            }
            
            # Reload nginx with verification
            echo "ğŸ”„ Reloading nginx..."
            sudo systemctl reload nginx
            sleep 2
            
            if systemctl is-active --quiet nginx; then
              echo "âœ… Nginx reloaded successfully"
            else
              echo "âŒ Nginx failed to reload properly"
              exit 1
            fi
            
            # Post-deployment verification
            echo "ğŸ” Post-deployment verification..."
            
            # Check if files exist
            if [ -f "$SITE_DIR/index.html" ] && [ -f "$SITE_DIR/versions.json" ] && [ -d "$SITE_DIR/2025.4.ATL" ]; then
              echo "âœ… Core files deployed successfully"
            else
              echo "âŒ Core files missing after deployment"
              exit 1
            fi
            
            # Check Orlando protection
            if [ "$ORLANDO_PROTECTED" = true ] && [ -d "$SITE_DIR/2025.1.ORL" ]; then
              echo "âœ… Orlando protection verified"
            elif [ "$ORLANDO_PROTECTED" = true ]; then
              echo "âŒ Orlando protection failed"
              exit 1
            fi
            
            # Cleanup
            echo "ğŸ§¹ Cleaning up temporary files..."
            rm -rf "$TEMP_DIR" /tmp/nginx-deployment.tar.gz
            
            # Keep backup for 24 hours, then auto-cleanup
            echo "â° Backup will be auto-cleaned in 24 hours"
            echo "sudo rm -rf $BACKUP_DIR" | at now + 24 hours 2>/dev/null || echo "â„¹ï¸ Auto-cleanup scheduling not available"
            
            echo "ğŸ‰ Deployment completed successfully!"
            echo "â° Completion time: $(date)"
            echo "ğŸ“‹ Deployment ID: $DEPLOY_TIMESTAMP"
            echo "ğŸŒ Site should be available at: http://${{ env.SERVER_HOST }}/"
          DEPLOY_SCRIPT
          
          echo "ğŸ‰ Nginx deployment completed successfully!"
          echo "â° Total deployment time: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      - name: ğŸ§ª Dry Run Simulation
        if: ${{ github.event.inputs.dry_run == 'true' }}
        run: |
          echo "ğŸ§ª DRY RUN MODE - No actual deployment performed"
          echo "ğŸ“‹ Would deploy to: ${{ env.SERVER_HOST }}"
          echo "ğŸ›¡ï¸ Orlando protection: ${{ github.event.inputs.skip_orlando_protection != 'true' && 'ENABLED' || 'DISABLED' }}"
          echo "ğŸ“¦ Package size: $(ls -lh nginx-deployment.tar.gz | awk '{print $5}')"
          echo "âœ… Dry run completed successfully"

      - name: ğŸ“Š Deployment Summary
        if: always()
        run: |
          echo "ğŸ“Š DEPLOYMENT SUMMARY"
          echo "===================="
          echo "ğŸŒ Site URL: http://${{ env.SERVER_HOST }}/"
          echo "ğŸ“… Deployment Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ğŸ”„ Trigger: ${{ github.event_name }}"
          echo "ğŸ›¡ï¸ Orlando Protected: ${{ github.event.inputs.skip_orlando_protection != 'true' && 'YES' || 'NO' }}"
          echo "ğŸ§ª Dry Run: ${{ github.event.inputs.dry_run == 'true' && 'YES' || 'NO' }}"
          echo "âœ… GitHub Pages: ${{ needs.build-and-deploy-pages.outputs.pages-url }}"
          echo "ğŸ“‹ Available Versions:"
          echo "  - ğŸ¯ Atlanta 2025.4.ATL [latest] - WITH enumerated ATD Lab labels"
          echo "  - ğŸ›¡ï¸ Orlando 2025.1.ORL [historical] - PROTECTED"
          echo ""
          echo "ğŸŠ Campus Workshop deployment completed!"
