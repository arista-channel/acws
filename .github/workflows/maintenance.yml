# Maintenance and Cleanup for Campus Workshop
name: Maintenance

on:
  schedule:
    # Run weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  
  workflow_dispatch:
    inputs:
      cleanup_type:
        description: 'Type of cleanup to perform'
        required: true
        type: choice
        options:
          - 'all'
          - 'backups'
          - 'logs'
          - 'temp'
        default: 'all'
      dry_run:
        description: 'Dry run (test without actual cleanup)'
        type: boolean
        default: true

env:
  SERVER_USER: ubuntu
  SERVER_PATH: /var/www/mkdocs/site

jobs:
  maintenance:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.8.0
        with:
          ssh-private-key: ${{ secrets.NGINX_SERVER_SSH_KEY }}

      - name: Add server to known hosts
        run: |
          ssh-keyscan -H acws.duckdns.org >> ~/.ssh/known_hosts

      - name: Check server connectivity
        run: |
          echo "ðŸ”— Testing connection to acws.duckdns.org..."
          ssh ${{ env.SERVER_USER }}@acws.duckdns.org "echo 'Maintenance connection successful'"

      - name: Cleanup old backups
        if: ${{ github.event.inputs.cleanup_type == 'all' || github.event.inputs.cleanup_type == 'backups' }}
        run: |
          IS_DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"
          
          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "ðŸ§ª DRY RUN: Would cleanup old backups..."
            ssh ${{ env.SERVER_USER }}@acws.duckdns.org "
              echo 'ðŸ§¹ Backup cleanup simulation:'
              echo 'Current backups:'
              sudo find /var/www/ -name 'mkdocs-site.backup.*' -type d | sort
              echo ''
              echo 'Would keep 5 most recent backups and remove:'
              sudo find /var/www/ -name 'mkdocs-site.backup.*' -type d | sort | head -n -5
            "
          else
            echo "ðŸ§¹ Cleaning up old backups..."
            ssh ${{ env.SERVER_USER }}@acws.duckdns.org "
              # Keep only the 5 most recent backups
              cd /var/www/
              sudo find . -name 'mkdocs-site.backup.*' -type d | sort -r | tail -n +6 | sudo xargs rm -rf

              echo 'Remaining backups:'
              sudo find . -name 'mkdocs-site.backup.*' -type d | sort
            "
          fi

      - name: Cleanup temporary files
        if: ${{ github.event.inputs.cleanup_type == 'all' || github.event.inputs.cleanup_type == 'temp' }}
        run: |
          IS_DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"
          
          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "ðŸ§ª DRY RUN: Would cleanup temporary files..."
            ssh ${{ env.SERVER_USER }}@acws.duckdns.org "
              echo 'ðŸ§¹ Temporary files cleanup simulation:'
              echo 'Would remove:'
              sudo find /tmp/ -name 'campus-workshop-*' -type d -mtime +1 2>/dev/null || echo 'No temp directories found'
              sudo find /tmp/ -name 'orlando-backup-*' -type d -mtime +1 2>/dev/null || echo 'No Orlando backup temp directories found'
            "
          else
            echo "ðŸ§¹ Cleaning up temporary files..."
            ssh ${{ env.SERVER_USER }}@acws.duckdns.org "
              # Remove temporary directories older than 1 day
              sudo find /tmp/ -name 'campus-workshop-*' -type d -mtime +1 -exec rm -rf {} \; 2>/dev/null || true
              sudo find /tmp/ -name 'orlando-backup-*' -type d -mtime +1 -exec rm -rf {} \; 2>/dev/null || true
              echo 'âœ… Temporary files cleaned up'
            "
          fi

      - name: Cleanup logs
        if: ${{ github.event.inputs.cleanup_type == 'all' || github.event.inputs.cleanup_type == 'logs' }}
        run: |
          IS_DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"
          
          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "ðŸ§ª DRY RUN: Would cleanup logs..."
            ssh ${{ env.SERVER_USER }}@mb-acws1 "
              echo 'ðŸ§¹ Log cleanup simulation:'
              echo 'Nginx access logs size:'
              sudo du -h /var/log/nginx/access.log* 2>/dev/null || echo 'No access logs found'
              echo 'Nginx error logs size:'
              sudo du -h /var/log/nginx/error.log* 2>/dev/null || echo 'No error logs found'
              echo 'Would rotate and compress logs older than 30 days'
            "
          else
            echo "ðŸ§¹ Cleaning up logs..."
            ssh ${{ env.SERVER_USER }}@mb-acws1 "
              # Rotate nginx logs if they're large
              if [ -f /var/log/nginx/access.log ] && [ \$(stat -c%s /var/log/nginx/access.log) -gt 104857600 ]; then
                echo 'Rotating large access log...'
                sudo logrotate -f /etc/logrotate.d/nginx
              fi
              
              # Clean up old compressed logs (older than 30 days)
              sudo find /var/log/nginx/ -name '*.gz' -mtime +30 -delete 2>/dev/null || true
              echo 'âœ… Logs cleaned up'
            "
          fi

      - name: Verify Orlando protection integrity
        run: |
          echo "ðŸ›¡ï¸ Verifying Orlando 2025.1.ORL protection integrity..."
          
          ssh ${{ env.SERVER_USER }}@mb-acws1 "
            if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
              echo 'âœ… Orlando 2025.1.ORL directory exists'
              
              if [ -f '${{ env.SERVER_PATH }}/2025.1.ORL/index.html' ]; then
                echo 'âœ… Orlando index.html is intact'
              else
                echo 'âŒ CRITICAL: Orlando index.html is missing!'
                exit 1
              fi
              
              if [ -f '${{ env.SERVER_PATH }}/2025.1.ORL/lab/access/index.html' ]; then
                echo 'âœ… Orlando lab access page is intact'
              else
                echo 'âŒ CRITICAL: Orlando lab access page is missing!'
                exit 1
              fi
              
              # Check file permissions
              ORLANDO_PERMS=\$(stat -c '%a' '${{ env.SERVER_PATH }}/2025.1.ORL')
              if [ \"\$ORLANDO_PERMS\" = '755' ]; then
                echo 'âœ… Orlando directory permissions are correct (755)'
              else
                echo \"âš ï¸ Orlando directory permissions: \$ORLANDO_PERMS (expected 755)\"
              fi
              
            else
              echo 'âŒ CRITICAL: Orlando 2025.1.ORL directory is missing!'
              exit 1
            fi
          "

      - name: System health check
        run: |
          echo "ðŸ¥ Performing system health check..."
          
          ssh ${{ env.SERVER_USER }}@mb-acws1 "
            echo 'ðŸ“Š System Status:'
            echo '==============='
            
            # Disk usage
            echo 'Disk Usage:'
            df -h /var/www/
            echo ''
            
            # Memory usage
            echo 'Memory Usage:'
            free -h
            echo ''
            
            # Nginx status
            echo 'Nginx Status:'
            sudo systemctl status nginx --no-pager -l | head -10
            echo ''
            
            # Check if site is accessible
            echo 'Site Accessibility:'
            HTTP_CODE=\$(curl -s -o /dev/null -w '%{http_code}' http://localhost/)
            if [ \"\$HTTP_CODE\" = '200' ]; then
              echo \"âœ… Site is accessible (HTTP \$HTTP_CODE)\"
            else
              echo \"âš ï¸ Site returned HTTP \$HTTP_CODE\"
            fi
            
            # Check Orlando accessibility
            if [ -d '${{ env.SERVER_PATH }}/2025.1.ORL' ]; then
              ORLANDO_CODE=\$(curl -s -o /dev/null -w '%{http_code}' http://localhost/2025.1.ORL/)
              if [ \"\$ORLANDO_CODE\" = '200' ]; then
                echo \"âœ… Orlando is accessible (HTTP \$ORLANDO_CODE)\"
              else
                echo \"âš ï¸ Orlando returned HTTP \$ORLANDO_CODE\"
              fi
            fi
          "

      - name: Create maintenance summary
        run: |
          IS_DRY_RUN="${{ github.event.inputs.dry_run || 'true' }}"
          CLEANUP_TYPE="${{ github.event.inputs.cleanup_type || 'all' }}"
          
          if [[ "$IS_DRY_RUN" == "true" ]]; then
            echo "## ðŸ§ª Campus Workshop Maintenance Dry Run Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Mode**: DRY RUN (No actual cleanup)" >> $GITHUB_STEP_SUMMARY
          else
            echo "## ðŸ§¹ Campus Workshop Maintenance Summary" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Mode**: LIVE CLEANUP" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "- **Cleanup Type**: $CLEANUP_TYPE" >> $GITHUB_STEP_SUMMARY
          echo "- **Server**: mb-acws1" >> $GITHUB_STEP_SUMMARY
          echo "- **Orlando Protection**: âœ… Verified intact" >> $GITHUB_STEP_SUMMARY
          echo "- **System Health**: âœ… Checked" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [[ "$CLEANUP_TYPE" == "all" || "$CLEANUP_TYPE" == "backups" ]]; then
            echo "### ðŸ—‚ï¸ Backup Cleanup" >> $GITHUB_STEP_SUMMARY
            if [[ "$IS_DRY_RUN" == "true" ]]; then
              echo "- ðŸ§ª Would keep 5 most recent backups" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… Kept 5 most recent backups" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [[ "$CLEANUP_TYPE" == "all" || "$CLEANUP_TYPE" == "temp" ]]; then
            echo "### ðŸ—‘ï¸ Temporary Files" >> $GITHUB_STEP_SUMMARY
            if [[ "$IS_DRY_RUN" == "true" ]]; then
              echo "- ðŸ§ª Would remove temp files older than 1 day" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… Removed temp files older than 1 day" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          if [[ "$CLEANUP_TYPE" == "all" || "$CLEANUP_TYPE" == "logs" ]]; then
            echo "### ðŸ“‹ Log Cleanup" >> $GITHUB_STEP_SUMMARY
            if [[ "$IS_DRY_RUN" == "true" ]]; then
              echo "- ðŸ§ª Would rotate large logs and remove old compressed logs" >> $GITHUB_STEP_SUMMARY
            else
              echo "- âœ… Rotated large logs and removed old compressed logs" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ›¡ï¸ Orlando Protection Status" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Orlando 2025.1.ORL directory intact" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Orlando files verified" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Orlando permissions correct" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Orlando accessibility confirmed" >> $GITHUB_STEP_SUMMARY
